"""
전문가 관점 요청 전략 실습 모듈

Part 6 - 섹션 6.3.2 실습 코드: AI와의 대화에서 전문가 관점을 효과적으로 
이끌어내는 구체적인 전략과 기법을 학습합니다.
"""

import os
import sys
from typing import Dict, List, Any, Optional

# 상위 디렉토리를 경로에 추가하여 utils 모듈을 import할 수 있게 설정
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.append(project_root)

from utils.prompt_builder import PromptBuilder
from utils.exercise_template import run_exercise

# 주제 옵션 정의
EXPERT_PERSPECTIVE_TOPICS = {
    "1": {"name": "의학/건강 상담", "topic": "의학 전문가 관점 요청 전략", "output_format": "임상 분석"},
    "2": {"name": "법률 자문", "topic": "법률 전문가 관점 요청 전략", "output_format": "법적 분석"},
    "3": {"name": "비즈니스 컨설팅", "topic": "경영 전문가 관점 요청 전략", "output_format": "전략 분석"},
    "4": {"name": "기술 자문", "topic": "기술 전문가 관점 요청 전략", "output_format": "기술 평가"},
    "5": {"name": "교육/심리 상담", "topic": "교육/심리 전문가 관점 요청 전략", "output_format": "전문 상담"}
}

# 프롬프트 요약 정보
PROMPT_SUMMARY = {
    "basic": ["일반적인 전문가 조언 요청"],
    "enhanced": [
        "구체적 전문성 프로필 설정",
        "분야별 프레임워크/사고과정 명시",
        "다층적/단계적 분석 요청",
        "자문 프로세스 시뮬레이션"
    ]
}

# 학습 포인트
LEARNING_POINTS = [
    "전문가 관점을 효과적으로 요청하려면 구체적인 전문성 영역, 경험, 배경을 명시하는 것이 중요합니다",
    "각 전문 분야는 고유한 방법론, 프레임워크, 분석 도구를 가지고 있으므로 이를 명시적으로 언급하면 더 전문적인 분석을 얻을 수 있습니다",
    "전문가의 사고 과정을 단계별로 분해하여 요청하면 더 체계적이고 깊이 있는 분석이 가능합니다",
    "실제 전문가 상담 세션을 시뮬레이션하는 프롬프트는 더 현실적이고 실용적인 조언을 이끌어냅니다",
    "분야별로 특화된 요청 패턴(의학적 진단, 법적 분석, 경영 컨설팅 등)을 활용하면 해당 분야에 적합한 관점을 얻을 수 있습니다"
]

def get_basic_prompt(topic: str) -> str:
    """기본 프롬프트 생성"""
    if "의학" in topic:
        return "이 건강 문제에 대해 의사의 관점에서 조언해주세요."
    elif "법률" in topic:
        return "이 상황에 대해 법률 전문가의 조언을 제공해주세요."
    elif "비즈니스" in topic:
        return "이 비즈니스 문제에 대해 컨설턴트로서 조언해주세요."
    elif "기술" in topic:
        return "이 기술적 문제에 대해 전문가 의견을 제공해주세요."
    elif "교육" in topic or "심리" in topic:
        return "이 교육/심리 문제에 대해 전문가 관점에서 분석해주세요."
    else:
        return f"{topic}에 대해 전문가 관점에서 분석해주세요."

def get_enhanced_prompt(topic: str, purpose: str, output_format: str) -> str:
    """향상된 프롬프트 생성"""
    builder = PromptBuilder()
    
    # 분야별 역할 및 맥락 설정
    if "의학" in topic:
        builder.add_role(
            "심장내과 전문의", 
            "대학병원에서 15년간 심장질환 환자를 진료한 심장내과 전문의로, 심부전, 관상동맥질환, 부정맥 분야의 임상 경험이 풍부합니다. 국제 의료 저널에 다수의 논문을 발표했으며 복잡한 심장 질환의 진단과 치료에 전문성을 갖고 있습니다."
        )
        
        builder.add_context(
            "저는 최근 가슴 통증, 호흡곤란, 그리고 일상 활동 중 쉽게 피로감을 느끼는 55세 남성 환자입니다. "
            "고혈압과 제2형 당뇨병 병력이 있으며, 가족력으로는 부친이 60세에 심장마비로 사망했습니다. "
            "심장 건강에 대한 우려가 있어 심장내과 전문의의 전문적인 관점에서 이러한 증상을 어떻게 "
            "평가하고 접근할지 알고 싶습니다."
        )
        
        builder.add_instructions([
            "심장내과 전문의의 임상적 사고 프로세스를 따라 이 증상을 체계적으로 분석해주세요",
            "주요 증상과 위험 요인을 분류하고 우선순위를 정해주세요",
            "감별 진단 목록을 작성하고 각 가능성의 임상적 근거를 설명해주세요",
            "추가로 필요한 검사와 그 임상적 근거를 우선순위에 따라 제안해주세요",
            "일차 진료 단계에서 적절한 조치와 전문의 진료가 필요한 위험 신호를 설명해주세요",
            "실제 심장내과 전문의와의 상담 세션처럼 환자에게 필요한 추가 질문과 임상적 사고 과정을 보여주세요"
        ])
        
    elif "법률" in topic:
        builder.add_role(
            "지적재산권 변호사", 
            "기술 산업 분야에서 15년간 활동한 지적재산권 전문 변호사로, 특허 출원, 상표권 보호, 저작권 분쟁, 기술 라이센싱 계약에 전문성을 갖고 있습니다. 다수의 스타트업과 기술 기업들을 대리하여 IP 전략 수립과 분쟁 해결을 지원한 경험이 있습니다."
        )
        
        builder.add_context(
            "저는 소프트웨어 기반 스타트업을 창업 중인 기업가입니다. 우리 회사는 인공지능을 활용한 "
            "교육 플랫폼을 개발하고 있으며, 곧 베타 버전을 출시할 예정입니다. 우리의 핵심 알고리즘과 "
            "사용자 인터페이스를 어떻게 법적으로 보호할 수 있는지, 오픈소스 라이브러리 사용과 관련된 "
            "법적 위험은 무엇인지, 그리고 초기 단계에서 갖춰야 할 IP 보호 전략에 대해 알고 싶습니다."
        )
        
        builder.add_instructions([
            "지적재산권 변호사로서 소프트웨어 스타트업의 IP 보호 전략을 IRAC 방법론에 따라 분석해주세요",
            "소프트웨어 보호를 위한 특허, 저작권, 영업비밀, 상표 등 다양한 IP 보호 메커니즘의 적용 가능성과 장단점을 비교해주세요",
            "오픈소스 라이브러리 사용에 따른 법적 의무와 잠재적 리스크를 분석하고 관리 방안을 제시해주세요",
            "초기 스타트업 단계에서 비용 효율적으로 IP를 보호하기 위한 우선순위와 단계적 접근법을 제안해주세요",
            "잠재적 법적 분쟁 리스크를 최소화하기 위한 IP 실사 및 문서화 전략을 설명해주세요",
            "실제 법률 상담 세션처럼 상담자에게 추가로 필요한 정보와 질문, 그리고 법적 추론 과정을 보여주세요"
        ])
        
    elif "비즈니스" in topic:
        builder.add_role(
            "전략 경영 컨설턴트", 
            "글로벌 경영 컨설팅 회사에서 20년간 리테일, 소비재, 디지털 트랜스포메이션 분야의 기업 전략을 자문한 수석 컨설턴트입니다. 시장 진입 전략, 디지털 혁신, 조직 변화 관리, 성장 전략 수립에 전문성을 갖고 있으며, 포춘 500대 기업부터 스케일업 기업까지 다양한 규모의 기업을 컨설팅한 경험이 있습니다."
        )
        
        builder.add_context(
            "저는 중견 리테일 기업의 최고전략책임자(CSO)입니다. 우리 회사는 전통적인 오프라인 매장을 "
            "중심으로 성장해왔으나, 최근 5년간 디지털 채널로의 소비자 이동과 코로나19 이후 소비 행태 "
            "변화로 매출이 정체되고 있습니다. 디지털 트랜스포메이션을 통해 옴니채널 전략을 강화하고 "
            "새로운 성장 동력을 찾고자 합니다. 제한된 자원으로 효과적인 디지털 전환을 이루기 위한 "
            "전략적 접근법에 대해 컨설팅이 필요합니다."
        )
        
        builder.add_instructions([
            "전략 컨설턴트로서 구조화된 문제 해결 접근법을 사용하여 이 비즈니스 도전 과제를 체계적으로 분석해주세요",
            "리테일 기업의 디지털 트랜스포메이션을 위한 현황 분석 프레임워크(As-Is)와, 포터의 5가지 경쟁요인 모델을 활용한 산업 분석을 제시해주세요",
            "디지털 옴니채널 전략의 주요 구성요소와 우선순위를 자원 제약을 고려하여 도출해주세요",
            "단계적 디지털 전환을 위한 로드맵과 주요 이정표(마일스톤)를 제안해주세요",
            "제안한 전략의 성공적 실행을 위한 조직적, 기술적, 문화적 고려사항과 변화 관리 접근법을 설명해주세요",
            "실제 전략 컨설팅 세션처럼 클라이언트에게 필요한 추가 질문과 전략적 사고 과정, 그리고 벤치마킹 사례를 포함해주세요"
        ])
        
    elif "기술" in topic:
        builder.add_role(
            "시스템 아키텍트", 
            "20년 경력의 시스템 아키텍트로, 대규모 엔터프라이즈 시스템, 클라우드 마이그레이션, 분산 시스템 설계에 전문성을 갖고 있습니다. 금융, 의료, 전자상거래 분야의 미션 크리티컬 시스템을 설계하고 구현한 경험이 있으며, 성능, 확장성, 보안, 비용 효율성을 모두 고려한 아키텍처 솔루션을 개발하는 데 전문성이 있습니다."
        )
        
        builder.add_context(
            "저는 빠르게 성장하는 전자상거래 기업의 기술 책임자입니다. 현재 우리 플랫폼은 모놀리식 "
            "아키텍처를 사용하고 있으며, 트래픽 증가와 기능 추가로 인해 성능 및 확장성 문제가 "
            "발생하고 있습니다. 또한 시스템 안정성 저하와 배포 주기 지연으로 비즈니스 민첩성이 "
            "떨어지고 있습니다. 마이크로서비스 아키텍처로의 전환을 고려하고 있으나, 구체적인 접근 방법과 "
            "전환 과정에서의 위험 요소를 파악하고 싶습니다."
        )
        
        builder.add_instructions([
            "시스템 아키텍트로서 이 기술적 도전 과제를 엔지니어링 문제 해결 프레임워크를 통해 체계적으로 분석해주세요",
            "모놀리식에서 마이크로서비스 아키텍처로 전환할 때의 기술적 고려사항, 장단점, 트레이드오프를 평가해주세요",
            "전자상거래 플랫폼에 적합한 마이크로서비스 도메인 경계 식별 방법과 설계 원칙을 제안해주세요",
            "단계적 마이그레이션 전략과 각 단계별 기술적 접근법, 위험 요소, 성공 지표를 설명해주세요",
            "마이크로서비스 아키텍처에서의 데이터 일관성, 서비스 간 통신, 모니터링, 장애 복구 전략을 설계해주세요",
            "실제 기술 컨설팅 세션처럼 클라이언트에게 필요한 추가 기술 정보와 아키텍처 설계 사고 과정을 보여주세요"
        ])
        
    elif "교육" in topic or "심리" in topic:
        builder.add_role(
            "교육심리 전문가", 
            "아동 및 청소년 발달 심리학 박사로, 학습 장애 진단 및 지원에 15년의 임상 경험을 가진 교육심리 전문가입니다. 공립 및 사립 학교에서 학습 지원 프로그램을 개발하고 교사와 학부모를 대상으로 한 워크숍을 진행해 왔으며, 다양한 학습 스타일과 특수 교육적 요구를 가진 학생들을 지원하는 개별화 교육 접근법 개발에 전문성이 있습니다."
        )
        
        builder.add_context(
            "저는 10세 아들을 둔 학부모입니다. 아들은 지능이 높고 창의적이지만, 학교에서 읽기와 "
            "집중력에 어려움을 겪고 있습니다. 교사는 읽기 속도가 또래보다 느리고, 지시사항을 따르는 데 "
            "어려움이 있으며, 조직화 기술이 부족하다고 보고했습니다. 하지만 이야기하기와 과학 실험에는 "
            "뛰어난 능력을 보입니다. 학교에서 특수 교육 평가를 권했으나, 어떤 종류의 학습 어려움이 "
            "있는지, 어떻게 아이를 가장 잘 지원할 수 있는지, 어떻게 아이를 가장 잘 지원할 수 있는지 전문가의 의견이 필요합니다."
        )
        
        builder.add_instructions([
            "교육심리 전문가로서 이 사례를 통합적 평가 프레임워크를 통해 체계적으로 분석해주세요",
            "학습 어려움의 패턴을 인지적, 정서적, 환경적 요인으로 분류하고 가능한 원인을 평가해주세요",
            "잠재적 학습 장애(난독증, ADHD 등)의 가능성과 진단적 징후를 설명해주세요",
            "교사와 학부모가 수집하고 관찰해야 할 추가 정보와 평가 과정을 설명해주세요",
            "학교와 가정에서 즉시 적용 가능한 지원 및 개입 전략을 우선순위에 따라 제안해주세요",
            "실제 교육심리 상담 세션처럼 학부모와의 대화 형식으로 정보 수집, 진단적 사고, 맞춤형 지원 계획 수립 과정을 보여주세요"
        ])
        
    else:
        builder.add_role(
            f"{purpose} 전문가", 
            f"{topic}에 깊은 전문성과 실무 경험을 갖춘 전문가로, 해당 분야의 구체적 방법론과 사고 과정을 활용하여 분석합니다."
        )
        
        builder.add_context(
            f"{topic}과 관련된 전문적 조언이 필요한 상황입니다. "
            f"해당 분야의 전문가로서 어떤 분석 프로세스와 접근법으로 "
            f"이 상황을 평가하고 조언할지 체계적으로 보여주세요."
        )
        
        builder.add_instructions([
            f"{topic} 관련 전문가의 체계적 분석 프로세스를 단계별로 보여주세요",
            "해당 분야의 핵심 프레임워크와 방법론을 활용한 분석을 제공해주세요",
            "표면적 정보를 넘어 심층적 요인과 맥락을 고려한 전문가적 통찰을 제시해주세요",
            "실무 경험에서 나온 암묵적 지식과 교과서적 지식을 통합한 분석을 제공해주세요",
            "전문가로서 고려하는 다양한 가능성과 대안적 접근법을 비교 분석해주세요",
            "실제 전문가 상담 세션처럼 체계적인 정보 수집, 분석, 권고안 제시 과정을 보여주세요"
        ])
    
    # 출력 형식 지정
    builder.add_format_instructions(
        f"응답은 {output_format} 형식으로 구성해주세요. "
        f"마크다운 형식을 사용하여 제목, 소제목, 목록 등을 명확히 구분해주세요. "
        f"실제 전문가 상담이나 자문 세션 형식으로 구성하되, 다음 단계를 포함해주세요:\n\n"
        f"1. 초기 평가 및 상황 분석\n"
        f"2. 전문적 프레임워크 적용 및 체계적 분석\n"
        f"3. 가능한 원인/해결책 도출 및 우선순위화\n"
        f"4. 구체적 권고안 및 다음 단계\n"
        f"5. 추가 고려사항 및 전문가적 통찰\n\n"
        f"해당 분야의 전문가가 실제 사용하는 전문 용어와 개념을 적절히 활용하되, "
        f"필요시 설명을 추가하여 일반인도 이해할 수 있도록 해주세요. "
        f"전문가로서의 사고 과정을 명시적으로 보여주고, 결론에 이르는 판단 과정을 투명하게 공개해주세요."
    )
    
    return builder.build()

def main():
    """메인 함수"""
    # 실행 결과를 저장할 때 챕터별 폴더 구조를 사용
    run_exercise(
        title="전문가 관점 요청 전략",
        topic_options=EXPERT_PERSPECTIVE_TOPICS,
        get_basic_prompt=get_basic_prompt,
        get_enhanced_prompt=get_enhanced_prompt,
        prompt_summary=PROMPT_SUMMARY,
        learning_points=LEARNING_POINTS
    )

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n프로그램이 사용자에 의해 중단되었습니다.")
    except Exception as err:
        print(f"\n오류 발생: {err}")
        print("API 키나 네트워크 연결을 확인하세요.")