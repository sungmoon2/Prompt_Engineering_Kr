"""
이공계 연구 및 실험 데이터 분석 실습 모듈

Part 6 - 섹션 6.2.2 실습 코드: 이공계 분야의 과학적 방법론과 데이터 분석에 최적화된
프롬프트 작성법을 학습합니다.
"""

import os
import sys
from typing import Dict, List, Any, Optional

# 상위 디렉토리를 경로에 추가하여 utils 모듈을 import할 수 있게 설정
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.append(project_root)

from utils.prompt_builder import PromptBuilder
from utils.exercise_template import run_exercise

# 주제 옵션 정의
SCIENCE_PROMPTS_TOPICS = {
    "1": {"name": "물리/공학", "topic": "역학 시스템 분석 및 모델링", "output_format": "분석 보고서"},
    "2": {"name": "생명과학/의학", "topic": "생물학적 실험 데이터 해석", "output_format": "연구 분석"},
    "3": {"name": "화학/재료과학", "topic": "화학 반응 메커니즘 분석", "output_format": "과학 설명"},
    "4": {"name": "데이터 과학", "topic": "실험 데이터의 통계적 분석 및 모델링", "output_format": "분석 워크플로우"},
    "5": {"name": "환경과학", "topic": "생태계 데이터 패턴 분석", "output_format": "데이터 인사이트"}
}

# 프롬프트 요약 정보
PROMPT_SUMMARY = {
    "basic": ["주제에 대한 일반적인 분석 요청"],
    "enhanced": [
        "과학적 방법론 기반: 체계적이고 실증적인 접근법 요청",
        "데이터 및 변수 명확화: 관련 데이터, 변수, 조건 상세 정의",
        "분석 프레임워크 명시: 관련 과학적 법칙, 이론, 모델 참조",
        "정확성 및 한계 인식: 가정, 오차, 불확실성 고려 요청"
    ]
}

# 학습 포인트
LEARNING_POINTS = [
    "이공계 분야는 실증적 접근, 체계적 방법론, 정량적 분석을 중시하므로 이를 프롬프트에 반영해야 합니다",
    "물리/공학, 생명과학/의학, 화학/재료과학 등 분야별 특화된 프롬프트 패턴을 활용하면 더 정확한 결과를 얻을 수 있습니다",
    "실험 데이터 분석을 위해 탐색적 분석, 통계적 검정, 모델링 등 단계별 최적화된 프롬프트를 개발할 수 있습니다",
    "과학적 의사소통을 위한 논문 구조화, 시각화 전략 등 전문적인 보고서 작성에 맞춘 프롬프트가 효과적입니다",
    "과학적 엄밀성을 유지하기 위해 데이터 출처, 방법론적 투명성, 한계점 인정 등을 프롬프트에 포함하는 것이 중요합니다"
]

def get_basic_prompt(topic: str) -> str:
    """기본 프롬프트 생성"""
    return f"{topic}에 대해 분석해주세요."

def get_enhanced_prompt(topic: str, purpose: str, output_format: str) -> str:
    """향상된 프롬프트 생성"""
    builder = PromptBuilder()
    
    # 분야별 역할 및 맥락 설정
    if "물리/공학" in purpose:
        builder.add_role(
            "물리 시스템 분석 전문가",
            "복잡한 역학 시스템을 수학적으로 모델링하고 분석하는 물리학자/공학자로, 다양한 물리적 시스템의 거동을 정확하게 예측하고 설명하는 전문가"
        )
        
        builder.add_context(
            f"저는 공학 전공 학생으로 {topic}에 관한 도움이 필요합니다. "
            f"특정 역학 시스템의 동작을 이해하고 수학적으로 모델링하려고 합니다. "
            f"이 시스템은 진자가 연결된 스프링-질량 시스템으로, 감쇠와 외부 힘의 영향을 받습니다. "
            f"시스템의 움직임을 설명하는 미분방정식을 세우고, 시스템의 동작을 분석하고자 합니다."
        )
        
        builder.add_instructions([
            "시스템에 적용되는 물리 법칙(뉴턴의 운동법칙, 훅의 법칙 등)을 명확히 설명하고 적용해주세요",
            "시스템의 수학적 모델링: 운동 방정식 도출 과정을 단계별로 상세히 보여주세요",
            "해석적 해법(가능한 경우)과 수치적 접근법을 모두 설명해주세요",
            "시스템의 주요 물리적 특성(고유 진동수, 감쇠 계수, 공진 조건 등)을 분석해주세요",
            "다양한 초기 조건과 매개변수가 시스템 거동에 미치는 영향을 설명해주세요",
            "실용적인 응용 사례와 공학적 중요성도 포함해주세요"
        ])
        
    elif "생명과학" in purpose or "의학" in purpose:
        builder.add_role(
            "생물학적 데이터 분석 전문가",
            "실험 데이터를 통계적으로 분석하고 생물학적 의미를 해석하는 생명과학 연구자로, 복잡한 생물학적 실험 결과를 체계적으로 평가하고 의미 있는 결론을 도출하는 전문가"
        )
        
        builder.add_context(
            f"저는 생물학과 학생으로 {topic}에 관한 도움이 필요합니다. "
            f"식물 성장에 대한 새로운 처리법의 효과를 연구하는 실험을 수행했습니다. "
            f"세 그룹(대조군, 처리 A, 처리 B)에 각각 20개의 식물 샘플을 배정하고, "
            f"8주 동안 성장 높이, 잎 면적, 건조 중량을 측정했습니다. 이 데이터를 "
            f"어떻게 적절히 분석하고 해석해야 할지 조언이 필요합니다."
        )
        
        builder.add_instructions([
            "실험 설계 분석: 표본 크기의 적절성, 가능한 교란 변수, 실험 설계의 강점과 약점 평가",
            "적절한 통계적 방법 선택: 분산 분석(ANOVA), 사후 검정, 효과 크기 등의 적합한 통계 방법 제안",
            "데이터 시각화 전략: 결과를 효과적으로 표현할 수 있는 그래프 유형과 구성 방법 제안",
            "결과 해석: 통계적 유의성과 생물학적 의의의 구분, 가능한 메커니즘 논의",
            "방법론적 한계 및 대안적 해석: 데이터의 제한점과 다른 가능한 해석 고려",
            "후속 실험 제안: 현재 결과를 확장하거나 새로운 가설을 검증하기 위한 추가 실험 설계"
        ])
        
    elif "화학" in purpose or "재료과학" in purpose:
        builder.add_role(
            "화학 반응 메커니즘 전문가",
            "복잡한 화학 반응의 메커니즘을 분석하고 설명하는 화학자로, 분자 수준에서 반응 경로와 중간체를 규명하고 반응 속도론적/열역학적 특성을 평가하는 전문가"
        )
        
        builder.add_context(
            f"저는 화학과 학생으로 {topic}에 관한 도움이 필요합니다. "
            f"카르복실산과 알코올 사이의 에스테르화 반응(피셔 에스테르화)의 메커니즘을 "
            f"자세히 이해하고 싶습니다. 특히 산 촉매의 역할, 반응 중간체, 반응 속도에 "
            f"영향을 미치는 요인, 그리고 이 반응의 열역학적 측면에 대해 깊이 있는 분석이 필요합니다."
        )
        
        builder.add_instructions([
            "반응의 전체 메커니즘을 단계별로 상세히 설명하고, 각 단계에서 일어나는 분자 수준의 변화를 명확히 해주세요",
            "산 촉매의 정확한 역할과 작용 메커니즘을 설명해주세요",
            "반응 중간체의 구조와 안정성, 그리고 이들이 반응 경로에 미치는 영향을 분석해주세요",
            "반응 속도에 영향을 미치는 주요 요인(온도, 농도, 촉매, 용매 효과 등)을 설명해주세요",
            "반응의 열역학적 특성(엔탈피, 엔트로피, 깁스 자유 에너지 변화)과 평형 상수에 대해 논의해주세요",
            "이 반응 메커니즘의 산업적 응용과 관련 반응과의 비교도 포함해주세요"
        ])
        
    elif "데이터 과학" in purpose:
        builder.add_role(
            "실험 데이터 분석 전문가",
            "과학적 실험 데이터를 통계적으로 분석하고 모델링하는 데이터 과학자로, 적절한 분석 방법론을 선택하고 의미 있는 패턴을 발견하여 과학적 결론을 도출하는 전문가"
        )
        
        builder.add_context(
            f"저는 연구원으로 {topic}에 관한 도움이 필요합니다. "
            f"신약 후보 물질의 효능을 테스트한 실험 데이터를 분석해야 합니다. "
            f"데이터셋은 5개 농도 수준에서 3번의 반복 실험으로 측정된 세포 생존율을 "
            f"포함하고 있으며, 대조군과 비교하여 용량-반응 관계를 파악하고 IC50 값을 "
            f"추정해야 합니다. 데이터에는 일부 이상치와 결측값이 있을 수 있습니다."
        )
        
        builder.add_instructions([
            "탐색적 데이터 분석(EDA): 데이터의 구조, 분포, 이상치, 결측값에 대한 체계적 분석",
            "적절한 통계 모델 선택: 용량-반응 곡선 피팅에 적합한 모델(로그-로지스틱, 힐 방정식 등) 제안 및 정당화",
            "모델 적합성 평가: 잔차 분석, 적합도 검정, 매개변수 추정의 신뢰성 평가",
            "IC50 추정 및 신뢰구간: 점 추정치와 함께 불확실성 정량화",
            "결과 시각화: 데이터와 피팅 곡선의 효과적인 시각적 표현 방법",
            "분석의 한계 및 개선 방안: 현재 접근법의 제한점과 대안적 분석 방법 논의"
        ])
        
    elif "환경과학" in purpose:
        builder.add_role(
            "생태계 데이터 분석 전문가",
            "생태계 모니터링 데이터를 분석하고 생태적 패턴과 관계를 발견하는 환경 과학자로, 복잡한 환경 데이터에서 의미 있는 추세와 상호작용을 규명하는 전문가"
        )
        
        builder.add_context(
            f"저는 환경과학 연구자로 {topic}에 관한 도움이 필요합니다. "
            f"보호 구역 내 다양한 지점에서 5년간 수집된 생태계 데이터를 분석하고 있습니다. "
            f"데이터는 식물 종 다양성, 토양 특성(pH, 영양소), 기후 변수(온도, 강수량), "
            f"그리고 인간 활동 지표(방문객 수, 근처 개발 정도)를 포함합니다. "
            f"이러한 변수들 간의 관계와 시간에 따른 변화 패턴을 이해하고자 합니다."
        )
        
        builder.add_instructions([
            "시공간적 패턴 분석: 데이터의 지리적 분포와 시간에 따른 변화 패턴을 파악하는 방법",
            "다변량 분석 접근법: 여러 환경 변수 간의 상호관계를 분석하기 위한 적절한 통계 방법(PCA, 군집 분석, 정준 상관 분석 등) 제안",
            "생물다양성 지표 분석: 다양한 생물다양성 측정 방법과 그 해석",
            "환경 요인과 생물다양성의 관계: 회귀 분석, 구조 방정식 모델링 등을 통한 인과 관계 탐색",
            "시계열 분석: 장기적 추세, 계절성, 변동성을 식별하는 방법",
            "생태계 건강 평가: 데이터를 기반으로 한 생태계 상태 및 회복력 평가 프레임워크"
        ])
        
    else:
        builder.add_role(
            f"{purpose} 전문가", 
            f"{topic}에 대한 과학적 분석과 해석을 제공하는 연구자"
        )
        
        builder.add_context(
            f"저는 과학 연구자로 {topic}에 관한 도움이 필요합니다. "
            f"이 주제에 대한 체계적이고 과학적인 분석을 통해 현상을 이해하고 "
            f"관련 데이터를 해석하고자 합니다."
        )
        
        builder.add_instructions([
            f"{topic}과 관련된 주요 과학적 원리와 법칙을 설명해주세요",
            "적용 가능한 방법론과 분석 프레임워크를 제안해주세요",
            "관련 데이터를 분석하고 해석하는 적절한 접근법을 설명해주세요",
            "분석의 한계와 불확실성을 식별해주세요",
            "과학적 발견의 의미와 잠재적 응용을 논의해주세요",
            "추가 연구나 탐구를 위한 방향을 제안해주세요"
        ])
    
    # 출력 형식 지정
    builder.add_format_instructions(
        f"응답은 {output_format} 형식으로 구성해주세요. "
        f"마크다운 형식을 사용하여 제목, 소제목, 목록 등을 명확히 구분해주세요. "
        f"다음과 같은 구조로 체계적으로 정리해주세요:\n\n"
        f"1. 서론: 분석 목표와 접근 방법 개요\n"
        f"2. 이론적 배경: 관련 과학적 원리와 법칙\n"
        f"3. 방법론: 분석 방법과 적용 절차\n"
        f"4. 분석 결과: 단계별 분석과 핵심 발견\n"
        f"5. 논의: 결과 해석과 의미\n"
        f"6. 결론: 주요 발견과 함의\n\n"
        f"과학적 정확성과 엄밀성을 유지하되, 필요한 경우 개념을 명확히 설명해주세요. "
        f"방정식, 도표, 그래프 등을 적절히 활용하여 정보를 효과적으로 전달해주세요. "
        f"모든 주장은 과학적 원리나 데이터에 근거해야 하며, 가정이나 불확실성을 명시해주세요."
    )
    
    return builder.build()

def main():
    """메인 함수"""
    # 실행 결과를 저장할 때 챕터별 폴더 구조를 사용
    run_exercise(
        title="이공계 연구 및 실험 데이터 분석",
        topic_options=SCIENCE_PROMPTS_TOPICS,
        get_basic_prompt=get_basic_prompt,
        get_enhanced_prompt=get_enhanced_prompt,
        prompt_summary=PROMPT_SUMMARY,
        learning_points=LEARNING_POINTS
    )

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n프로그램이 사용자에 의해 중단되었습니다.")
    except Exception as err:
        print(f"\n오류 발생: {err}")
        print("API 키나 네트워크 연결을 확인하세요.")